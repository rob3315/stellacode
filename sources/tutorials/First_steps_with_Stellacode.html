<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>First steps with Stellacode &#8212; Stellacode  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Run a shape optimization" href="run_a_shape_optimization.html" />
    <link rel="prev" title="Quickstart" href="quickstart.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="First-steps-with-Stellacode">
<h1>First steps with Stellacode<a class="headerlink" href="#First-steps-with-Stellacode" title="Link to this heading">¶</a></h1>
<p>We need some basic import and we will set the current repository to be at the root of the Stellacode folder</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Basic import
import os,sys
import numpy as np
# We go up once to exit the example folder
if os.getcwd().split(&#39;/&#39;)[-1]==&#39;examples&#39;:
    os.chdir(&#39;../&#39;)
print(&#39;current directory is {}&#39;.format(os.getcwd()))
import numpy as np
# Full_shape_gradient is the main class to compute cost and shape gradient
from src.costs.full_shape_gradient import Full_shape_gradient
# We set the logging level to INFO to have a verbose program
import logging
logging.basicConfig(level=logging.INFO)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
current directory is /home/rrobin/Documents/Stellacage_code
</pre></div></div>
</div>
<section id="Choose-a-config-file">
<h2>Choose a config file<a class="headerlink" href="#Choose-a-config-file" title="Link to this heading">¶</a></h2>
<p>Nearly all of the functionalities in Stellacode need a general config file containing most of the simulation parameters. We will use a default one located in <em>stellacode/config_file/config.ini</em></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>path_config_file=&#39;config_file/config.ini&#39;
# We print the config file
with open(path_config_file,&#39;r&#39;) as f:
    print(f.read())
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[geometry]
np = 3
ntheta_plasma = 64
ntheta_coil = 64
nzeta_plasma = 64
nzeta_coil = 64
mpol_coil = 8
ntor_coil = 8
path_plasma = data/li383/plasma_surf.txt
path_cws = data/li383/cws.txt

[other]
path_bnorm = data/li383/bnorm.txt
net_poloidal_current_amperes = 11884578.094260072
net_toroidal_current_amperes = 0.
curpol = 4.9782004309255496
path_output = output_test2
lamb = 1.2e-14
dask = True
cupy = False


[dask_parameters]
chunk_theta_coil=32
chunk_zeta_coil=32
chunk_theta_plasma=32
chunk_zeta_plasma=32
chunk_theta=17

[optimization_parameters]
freq_save=100
max_iter=2000
d_min=True
d_min_hard = 0.18
d_min_soft= 0.19
d_min_penalization=1000
perim=True
perim_c0=56
perim_c1=60
curvature=True
curvature_c0=13
curvature_c1=15
</pre></div></div>
</div>
<p><strong>If you do not have much memory on your computer consider using a config file with a smaller resolution.</strong></p>
<p>for e.g.</p>
<p><code class="docutils literal notranslate"><span class="pre">path_config_file='config_file/config_small.ini'</span></code></p>
</section>
<section id="The-Full_shape_gradient-object">
<h2>The Full_shape_gradient object<a class="headerlink" href="#The-Full_shape_gradient-object" title="Link to this heading">¶</a></h2>
<p>All costs and gradient of a surface are handle by an object Full_shape_gradient. We can initialize one by giving him the path to the config file.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>full_grad=Full_shape_gradient(path_config_file=path_config_file)
</pre></div>
</div>
</div>
<p>Our object full_grad has two very useful functions : cost and shape_grad. Both need a 1D array parametrizing the CWS to work.</p>
<p>By default, full_grad store the surface parameters of the CWS given by the config file as full_grad.init_param</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
S_parametrization=full_grad.init_param
# We can compute the cost of this surface
first_cost=full_grad.cost(S_parametrization)
print(&#39;the cost of this my CWS is {:.2e}&#39;.format(first_cost))
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Chi_B : 1.366275e-01, Chi_j : 1.000214e+14, EM cost : 1.336885e+00
INFO:root:sup j 3.943591e+06, sup B_err : 2.674856e-01
INFO:root:min_distance 1.919394e-01 m, Distance cost : 0.000000e+00
INFO:root:perimeter :5.567741e+01 m^2, perimeter cost : 0.000000e+00
INFO:root:maximal curvature 1.185919e+01 m^-1, curvature cost : 0.000000e+00
INFO:root:Total cost : 1.336885e+00
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
the cost of this my CWS is 1.34e+00
CPU times: user 16.1 s, sys: 9.56 s, total: 25.7 s
Wall time: 4.33 s
</pre></div></div>
</div>
<p>Note that all the ‘constraints costs’ (distance, perimeter, curvature) are zeros because the soft penalization bounds have not been reached.</p>
<p>Thus in particular, this cost should be the same as the one obtained by <a class="reference external" href="https://github.com/landreman/regcoil">Regcoil</a>.</p>
</section>
<section id="The-shape-gradient">
<h2>The shape gradient<a class="headerlink" href="#The-shape-gradient" title="Link to this heading">¶</a></h2>
<p><strong>Next step is memory expensive (around 10GB is needed) if you have not taken the smaller resolution.</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
shape_grad=full_grad.shape_gradient(S_parametrization)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 2min 47s, sys: 28.2 s, total: 3min 16s
Wall time: 22.4 s
</pre></div></div>
</div>
<p>Let us now perform a numerical gradient to check that our derivation is correct</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ls=len(S_parametrization) # number of degrees of freedom of the set space
dS_parametrization=2*np.random.random(ls)-np.ones(ls) # a perturbation direction
eps=1e-7
new_cost=full_grad.cost(S_parametrization+eps*dS_parametrization)
finite_difference_evaluation=(new_cost-first_cost)/eps
analytic_gradient=np.dot(shape_grad,dS_parametrization)
print(&#39;the finite difference obtained is : {}\n the analytic gradient gives {}&#39;.format(finite_difference_evaluation,analytic_gradient))
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Chi_B : 1.366275e-01, Chi_j : 1.000214e+14, EM cost : 1.336885e+00
INFO:root:sup j 3.943601e+06, sup B_err : 2.674854e-01
INFO:root:min_distance 1.919398e-01 m, Distance cost : 0.000000e+00
INFO:root:perimeter :5.567741e+01 m^2, perimeter cost : 0.000000e+00
INFO:root:maximal curvature 1.185931e+01 m^-1, curvature cost : 0.000000e+00
INFO:root:Total cost : 1.336885e+00
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
the finite difference obtained is : -0.5376960388048246
 the analytic gradient gives -0.5379303048997812
</pre></div></div>
</div>
</section>
<section id="Plotting-surfaces">
<h2>Plotting surfaces<a class="headerlink" href="#Plotting-surfaces" title="Link to this heading">¶</a></h2>
<p>We use <a class="reference external" href="https://docs.enthought.com/mayavi/mayavi/">Mayavi</a> for the plotting.</p>
<p>To plot a sequence of surface, just use the plot function from src.surface.surface_Fourier</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from src.surface.surface_Fourier import Surface_Fourier,plot,plot_function_on_surface
# We generate the surface from the 1D array S_parametrization
CWS=full_grad.get_surface(S_parametrization)# The coil winding surface
plasma_surface=full_grad.EM.Sp # The plasma surface has been saved by full_grad
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plot([CWS,plasma_surface])
</pre></div>
</div>
</div>
<p>You should see a figure looking like that. You can change the color of the surfaces and the background in the interactive mayavi setup.</p>
<p><img alt="mayavi_plot1" src="../../_images/fig1_tuto.png" /></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Stellacode</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configurations.html">Set your own settings for your simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uninstall.html">Uninstall</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">Licenses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="quickstart.html">Quickstart</a><ul>
      <li>Previous: <a href="quickstart.html" title="previous chapter">Quickstart</a></li>
      <li>Next: <a href="run_a_shape_optimization.html" title="next chapter">Run a shape optimization</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2021, R. Robin.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/sources/tutorials/First_steps_with_Stellacode.nblink.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>